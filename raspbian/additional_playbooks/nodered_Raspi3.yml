---
- name: Install Node-Red
  hosts: all
  remote_user: root
  become_user: root
  become: true

  tasks:
  - name: download nodered script
    get_url:
      url: https://raw.githubusercontent.com/node-red/raspbian-deb-package/master/resources/update-nodejs-and-nodered
      dest: /home/smarthome
      mode: 775

  - name: install nodered
    shell: "yes | /home/smarthome/update-nodejs-and-nodered"
    become_user: smarthome
    become: true
    become_method: su
    async: 1000
    poll: 5

  - name: Restart nodered service
    systemd: state=restarted name=nodered.service

  - name: httproot
    replace:
      destfile: /home/smarthome/.node-red/settings.js
      regexp: "//httpRoot:"
      replace: "httpRoot:"
